@using Newtonsoft.Json
@using Nozomi.Data.Models.Web.Analytical
@using Nozomi.Preprocessing
@using Nozomi.Service.Events.Interfaces
@inject ITickerEvent _TickerEvent
@model Nozomi.Data.Models.Currency.Currency

@{
    var tickerPairs = _TickerEvent.GetCurrencyTickerPairs(Model.Abbreviation);
}

<!-- Description Section -->
<div id="partialView" class="container space-2 space-top-md-4 space-bottom-md-3">
    @if (Model != null)
    {
        <div class="row">
            <div id="stickyBlockStartPoint" class="col-lg-5 mb-7 mb-lg-0">
                <!-- Sticky Block -->
                <div class="js-sticky-block pl-lg-4"
                     data-parent="#stickyBlockStartPoint"
                     data-sticky-view="lg"
                     data-start-point="#stickyBlockStartPoint"
                     data-end-point="#stickyBlockEndPoint"
                     data-offset-top="80"
                     data-offset-bottom="130">
                    <div class="mb-6">
                        <img :src="'/' + currency.LogoPath" class="mb-2" style="height: 48px;"/>
                        <h1 class="h2 text-primary font-weight-semi-bold">{{ currency.Name }}</h1>
                    </div>

                    <hr class="my-5">

                    <!-- List -->
                    <ul class="list-unstyled mb-0">
                        <li class="media mb-1">
                            <div class="d-flex w-40 w-sm-30">
                                <h3 class="h6">Abbreviation</h3>
                            </div>
                            <div class="media-body">
                                <small class="text-muted">
                                    {{ currency.Abbreviation }}
                                </small>
                            </div>
                        </li>

                        <li class="media mb-1">
                            <div class="d-flex w-40 w-sm-30">
                                <h4 class="h6">Sources</h4>
                            </div>
                            <div class="media-body">
                                <small class="d-block text-muted" v-for="cSource in currency.CurrencySources">
                                    {{ cSource.Source.Name }}
                                </small>
                            </div>
                        </li>
                    </ul>
                    <!-- End List -->

                    <hr class="my-5">

                    <div class="media">
                        <div class="d-flex w-40 w-sm-30">
                            <h4 class="h6">Share</h4>
                        </div>
                        <div class="media-body">
                            <!-- Social Networks -->
                            <ul class="list-inline mb-0">
                                <li class="list-inline-item">
                                    <a class="btn btn-sm btn-icon btn-soft-secondary btn-bg-transparent" href="#">
                                        <span class="fa fa-facebook-f btn-icon__inner"></span>
                                    </a>
                                </li>
                                <li class="list-inline-item">
                                    <a class="btn btn-sm btn-icon btn-soft-secondary btn-bg-transparent" href="#">
                                        <span class="fa fa-google btn-icon__inner"></span>
                                    </a>
                                </li>
                                <li class="list-inline-item">
                                    <a class="btn btn-sm btn-icon btn-soft-secondary btn-bg-transparent" href="#">
                                        <span class="fa fa-twitter btn-icon__inner"></span>
                                    </a>
                                </li>
                                <li class="list-inline-item">
                                    <a class="btn btn-sm btn-icon btn-soft-secondary btn-bg-transparent" href="#">
                                        <span class="fa fa-github btn-icon__inner"></span>
                                    </a>
                                </li>
                            </ul>
                            <!-- End Social Networks -->
                        </div>
                    </div>
                </div>
                <!-- End Sticky Block -->
            </div>


            <div class="col-lg-7">
                <p class="text-info">
                    {{ currency.Description }}
                </p>
            </div>
        </div>

        <div class="row pt-6">
            <div class="col">
                <div id="SVGmockupBg" class="svg-preloader">
                    <!-- Nav Classic -->
                    <div class="position-relative w-lg-85 bg-white text-center z-index-2 mx-lg-auto">
                        <ul class="nav nav-classic nav-rounded nav-shadow nav-justified" id="pills-tab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link font-weight-medium active" id="pills-one-tab" data-toggle="pill" href="#pills-one" role="tab" aria-controls="pills-one" aria-selected="true">
                                    <div class="d-md-flex justify-content-md-center align-items-md-center">
                                        <figure class="ie-height-40 d-none d-md-block w-100 max-width-6 mr-3">
                                            <img class="js-svg-injector" src="../../assets/svg/icons/icon-14.svg" alt="SVG"
                                                 data-parent="#SVGmockupBg">
                                        </figure>
                                        Statistics
                                    </div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link font-weight-medium" id="pills-two-tab" data-toggle="pill" href="#pills-two" role="tab" aria-controls="pills-two" aria-selected="false">
                                    <div class="d-md-flex justify-content-md-center align-items-md-center">
                                        <figure class="ie-height-40 d-none d-md-block w-100 max-width-6 mr-3">
                                            <img class="js-svg-injector" src="../../assets/svg/icons/icon-21.svg" alt="SVG"
                                                 data-parent="#SVGmockupBg">
                                        </figure>
                                        Markets
                                    </div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link font-weight-medium" id="pills-three-tab" data-toggle="pill" href="#pills-three"
                                   role="tab" aria-controls="pills-three" aria-selected="false">
                                    <div class="d-md-flex justify-content-md-center align-items-md-center">
                                        <figure class="ie-height-40 d-none d-md-block w-100 max-width-6 mr-3">
                                            <img class="js-svg-injector" src="../../assets/svg/icons/icon-5.svg" alt="SVG"
                                                 data-parent="#SVGmockupBg">
                                        </figure>
                                        Historical
                                    </div>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- End Nav Classic -->

                    <!-- Tab Content -->
                    <div class="tab-content" id="pills-tabContent">
                        <div class="tab-pane fade pt-9 show active" id="pills-one" role="tabpanel" aria-labelledby="pills-one-tab">
                            <!-- Mockup Block -->
                            <div class="row justify-content-lg-between align-items-lg-center">
                                <div v-for="aComp in currency.AnalysedComponents" class="col-6 p-3" v-if="aComp.Value != null">
                                    <h4>{{ getAnalysedCompTypeStr(aComp.ComponentType) }}</h4>
                                    <small class="h5 text-muted" v-if="aComp.UIFormatting == null">{{ aComp.Value }}</small>
                                    <small class="h5 text-primary" v-else>{{ getAnalysedCompStr(aComp) }}</small>
                                </div>
                            </div>
                            <!-- End Mockup Block -->
                        </div>
                        <div class="tab-pane fade pt-9" id="pills-two" role="tabpanel" aria-labelledby="pills-two-tab">
                            <!-- Mockup Block -->
                            <div class="row justify-content-lg-between align-items-lg-center">
                                <div class="col">
                                    <b-table :fields="tickerPairTableFields"
                                             :items="tickerPairs">
                                        <template slot="TickerPair" slot-scope="datum">
                                            {{ datum.item.TickerPair }}
                                        </template>
                                        <template slot="Source" slot-scope="datum">
                                            {{ datum.item.Source }}
                                        </template>
                                    </b-table>
                                    <!-- Mockup Block -->
                                </div>
                            </div>
                            <!-- End Mockup Block -->
                        </div>
                        <div class="tab-pane fade pt-9" id="pills-three" role="tabpanel" aria-labelledby="pills-three-tab">
                            <!-- Mockup Block -->
                            <div class="row justify-content-lg-between align-items-lg-center">
                                <div class="col">
                                    <b-table :items="getHistoricalPriceData().AnalysedHistoricItems"
                                             :fields="currencyHistoricPriceFields">
                                        <template slot="HistoricDateTime" slot-scope="datum">
                                            {{ moment(datum.item.HistoricDateTime).format('LLL') }}
                                        </template>
                                        <template slot="Value" slot-scope="datum">
                                            {{ numeral(datum.item.Value).format('$ 0[.]00') }}
                                        </template>
                                    </b-table>
                                </div>
                            </div>
                            <!-- End Mockup Block -->
                        </div>
                    </div>
                    <!-- End Tab Content -->
                </div>
            </div>
        </div>
        <div class="row pt-6" v-if="getHistoricalPriceData().AnalysedHistoricItems.length > 0">
            <div class="col">
                <div class="card card=frame">
                    <div class="card-body">
                        <la-cartesian autoresize :data="values">
                            <la-area curve :width="2" :bound="[0]" :width="2" prop="value"></la-area>
                            <la-y-axis></la-y-axis>
                            <la-tooltip></la-tooltip>
                        </la-cartesian>
                    </div>
                </div>
            </div>
        </div>
    }
</div>
<!-- End Description Section -->

@section Scripts
{
    <script>
    const vm = new Vue({
      // options
      el: "#partialView",
      // Just dish any random variable in for now
      data: {
        acTypes: @Html.Raw(Json.Serialize(NozomiServiceConstants.analysedComponentTypes, new JsonSerializerSettings
                 {
                     ReferenceLoopHandling = ReferenceLoopHandling.Ignore
                 })),
        reqCompTypes: @Html.Raw(Json.Serialize(NozomiServiceConstants.requestComponentTypes, new JsonSerializerSettings
                      {
                          ReferenceLoopHandling = ReferenceLoopHandling.Ignore
                      })),
        currency: @Html.Raw(Json.Serialize(Model, new JsonSerializerSettings
                  {
                      ReferenceLoopHandling = ReferenceLoopHandling.Ignore
                  })),
                  tickerPairs: @Html.Raw(Json.Serialize(tickerPairs, new JsonSerializerSettings
                               {
                                   ReferenceLoopHandling = ReferenceLoopHandling.Ignore
                               })),
        currencyHistoricPriceFields: [
          {
            key: 'HistoricDateTime',
            label: 'Date & time',
            sortable: true
          },
          {
            key: 'Value',
            label: 'Price',
            sortable: true
          }],
        tickerPairTableFields: [
          {
            key: 'TickerPair',
            label: 'Pair',
            sortable: true
          },
          {
            key: 'Source',
            label: 'Exchange',
            sortable: false
          }]
      },
      created: function() {
      },
      methods: {
        getAnalysedCompTypeStr(val) {
          if (this.acTypes != null) {
            for (i = 0; i < this.acTypes.length; i++) {
              if (this.acTypes[i].Value == val) {
                return this.acTypes[i].Key;
              }
            }
          }
          
          return null;
        },
        getAnalysedCompStr(aComp) {
          if (aComp.UIFormatting != null) {
            switch (aComp.ComponentType) {
            // TODO: Make sure this is not repeated, create a vue component for this.
            case @((int) AnalysedComponentType.MarketCap):
            case @((int) AnalysedComponentType.HourlyMarketCap):
            case @((int) AnalysedComponentType.DailyMarketCap): 
            case @((int) AnalysedComponentType.CurrentAveragePrice):
            case @((int) AnalysedComponentType.HourlyAveragePrice): 
            case @((int) AnalysedComponentType.DailyAveragePrice):
            case @((int) AnalysedComponentType.DailyPriceChange): 
            case @((int) AnalysedComponentType.WeeklyPriceChange):
            case @((int) AnalysedComponentType.MonthlyPriceChange): 
            case @((int) AnalysedComponentType.DailyPricePctChange):
            case @((int) AnalysedComponentType.HourlyPricePctChange): 
            case @((int) AnalysedComponentType.DailyVolume):
                return numeral(aComp.Value).format(aComp.UIFormatting).toString();
              default:
                return aComp.Value;
            }
          } else {
            return aComp.Value;
          }
        },
        getHistoricalPriceData() {
          if (this.currency != null && this.currency.AnalysedComponents != null) {
            for (let i = 0; i < this.currency.AnalysedComponents.length; i++) {
              const currentAc = this.currency.AnalysedComponents[i];
            
              if (currentAc.ComponentType === @((int) AnalysedComponentType.HourlyAveragePrice)) {
                return currentAc;
              }
            }
          }
          
          return [];
        }
      },
      mounted: function() {
      }
    });
  </script>
}